@page "/plan/{AppName}/{Environment}"
@using Deskribe.Web.Services
@using Deskribe.Sdk.Models
@using System.Text.Json
@inject DeskribeUiService UiService
@rendermode InteractiveServer

<PageTitle>Plan: @AppName (@Environment) - Deskribe</PageTitle>

<div class="page-header">
    <div>
        <h1>@AppName</h1>
        <div class="flex items-center gap-2 mt-2">
            <span class="env-pill @Environment">@Environment</span>
            @if (plan != null)
            {
                <span class="badge badge-healthy"><span class="status-dot healthy"></span> Plan Ready</span>
            }
        </div>
    </div>
    <div style="display: flex; gap: 8px;">
        <button class="btn btn-primary" @onclick="GeneratePlan" disabled="@isLoading">
            @if (isLoading) { <span class="spinner"></span> } Plan
        </button>
        <button class="btn btn-success" @onclick="ApplyPlan" disabled="@(plan == null || isApplying)">
            @if (isApplying) { <span class="spinner"></span> } Apply
        </button>
        <button class="btn btn-danger" @onclick="DestroyEnv" disabled="@isDestroying">
            @if (isDestroying) { <span class="spinner"></span> } Destroy
        </button>
    </div>
</div>

@if (errorMessage != null)
{
    <div class="toast error" style="margin-bottom: 16px;">@errorMessage</div>
}
@if (successMessage != null)
{
    <div class="toast success" style="margin-bottom: 16px;">@successMessage</div>
}

<div class="tab-nav">
    <button class="@(activeTab == "plan" ? "active" : "")" @onclick='() => activeTab = "plan"'>Plan</button>
    <button class="@(activeTab == "resources" ? "active" : "")" @onclick='() => activeTab = "resources"'>Resources</button>
    <button class="@(activeTab == "workload" ? "active" : "")" @onclick='() => activeTab = "workload"'>Workload</button>
    <button class="@(activeTab == "yaml" ? "active" : "")" @onclick='() => activeTab = "yaml"'>YAML Preview</button>
</div>

@if (plan == null && !isLoading)
{
    <div style="text-align: center; padding: 60px; color: var(--text-muted);">
        <div style="font-size: 48px; margin-bottom: 16px;">&#9881;</div>
        <p>Click <strong>Plan</strong> to generate an execution plan for <strong>@AppName</strong> in <strong>@Environment</strong></p>
    </div>
}
else if (isLoading)
{
    <div style="text-align: center; padding: 60px;">
        <div class="spinner" style="width: 40px; height: 40px; border-width: 3px;"></div>
        <p class="mt-4 text-secondary">Generating plan...</p>
    </div>
}
else if (plan != null)
{
    @if (activeTab == "plan")
    {
        <div class="plan-section">
            <h3 style="font-size: 16px; margin-bottom: 16px;">Resources (@plan.ResourcePlans.Count)</h3>
            @foreach (var rp in plan.ResourcePlans)
            {
                <div class="plan-resource">
                    <div class="plan-resource-header">
                        <span class="badge badge-create">@rp.Action.ToUpperInvariant()</span>
                        <span style="font-weight: 600; font-size: 15px;">@rp.ResourceType</span>
                    </div>
                    <div class="plan-resource-body">
                        @foreach (var (key, value) in rp.Configuration)
                        {
                            <div class="plan-config-item">
                                <span class="plan-config-key">@key</span>
                                <span class="plan-config-value">@FormatValue(value)</span>
                            </div>
                        }
                        @if (rp.PlannedOutputs.Count > 0)
                        {
                            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color);">
                                <div style="font-size: 11px; text-transform: uppercase; color: var(--text-muted); margin-bottom: 8px; font-weight: 600;">Outputs</div>
                                @foreach (var (key, value) in rp.PlannedOutputs)
                                {
                                    <div class="plan-config-item">
                                        <span class="plan-config-key">@key</span>
                                        <span class="plan-config-value">@value</span>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                </div>
            }
        </div>
    }

    @if (activeTab == "resources")
    {
        <div class="card">
            <div class="card-body" style="padding: 0;">
                <table class="resource-table">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Action</th>
                            <th>Backend</th>
                            <th>Namespace</th>
                            <th>Helm Chart</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var rp in plan.ResourcePlans)
                        {
                            <tr>
                                <td><span class="badge badge-resource">@rp.ResourceType</span></td>
                                <td><span class="badge badge-create">@rp.Action</span></td>
                                <td>@(plan.Platform.Backends.GetValueOrDefault(rp.ResourceType, "—"))</td>
                                <td style="font-family: monospace;">@(rp.Configuration.GetValueOrDefault("namespace")?.ToString() ?? "—")</td>
                                <td style="font-family: monospace; font-size: 12px;">@(rp.Configuration.GetValueOrDefault("helmChart")?.ToString() ?? "—")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }

    @if (activeTab == "workload" && plan.Workload != null)
    {
        <div class="workload-grid">
            <div class="workload-item">
                <div class="label">Namespace</div>
                <div class="value">@plan.Workload.Namespace</div>
            </div>
            <div class="workload-item">
                <div class="label">Image</div>
                <div class="value" style="font-size: 12px;">@(plan.Workload.Image ?? "not set")</div>
            </div>
            <div class="workload-item">
                <div class="label">Replicas</div>
                <div class="value">@plan.Workload.Replicas</div>
            </div>
            <div class="workload-item">
                <div class="label">CPU</div>
                <div class="value">@plan.Workload.Cpu</div>
            </div>
            <div class="workload-item">
                <div class="label">Memory</div>
                <div class="value">@plan.Workload.Memory</div>
            </div>
        </div>

        @if (plan.Workload.EnvironmentVariables.Count > 0)
        {
            <div class="card mt-4">
                <div class="card-header">
                    <h3>Environment Variables</h3>
                </div>
                <div class="card-body">
                    <ul class="env-var-list">
                        @foreach (var (key, value) in plan.Workload.EnvironmentVariables)
                        {
                            <li>
                                <span class="env-var-key">@key</span>
                                <span class="env-var-value">@value</span>
                            </li>
                        }
                    </ul>
                </div>
            </div>
        }
    }

    @if (activeTab == "yaml" && yamlPreview != null)
    {
        <div class="yaml-viewer">@yamlPreview</div>
    }
}

@code {
    [Parameter] public string AppName { get; set; } = "";
    [Parameter] public string Environment { get; set; } = "";

    private DeskribePlan? plan;
    private string? yamlPreview;
    private string? errorMessage;
    private string? successMessage;
    private bool isLoading;
    private bool isApplying;
    private bool isDestroying;
    private string activeTab = "plan";

    private async Task GeneratePlan()
    {
        isLoading = true;
        errorMessage = null;
        successMessage = null;

        try
        {
            plan = await UiService.PlanAsync(AppName, Environment, "nginx:latest");

            // Generate YAML preview
            var k8sAdapter = new Deskribe.Plugins.Runtime.Kubernetes.KubernetesRuntimeAdapter();
            if (plan.Workload != null)
            {
                var manifest = await k8sAdapter.RenderAsync(plan.Workload, CancellationToken.None);
                yamlPreview = manifest.Yaml;
            }
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task ApplyPlan()
    {
        if (plan == null) return;
        isApplying = true;
        errorMessage = null;

        try
        {
            await UiService.ApplyAsync(plan);
            successMessage = $"Successfully applied {AppName} to {Environment}!";
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
        finally
        {
            isApplying = false;
        }
    }

    private async Task DestroyEnv()
    {
        isDestroying = true;
        errorMessage = null;

        try
        {
            await UiService.DestroyAsync(AppName, Environment);
            successMessage = $"Successfully destroyed {AppName} in {Environment}!";
            plan = null;
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
        finally
        {
            isDestroying = false;
        }
    }

    private static string FormatValue(object? value)
    {
        if (value is null) return "null";
        if (value is JsonElement element) return element.ToString();
        if (value is string s) return s;
        return JsonSerializer.Serialize(value);
    }
}
